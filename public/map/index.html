<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nirmanakaya · The 78 Signatures</title>
    <link rel="icon" type="image/png" href="/favicon.png">
    <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,300;0,400;0,600;1,300&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body { width: 100%; height: 100%; overflow: hidden; }
        body {
            background: #0a0a0f;
            font-family: 'Cormorant Garamond', serif;
        }

        /* Video background - matches reader page */
        .video-background {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            z-index: -1;
            opacity: 0.4;
        }

        .canvas-container {
            width: 100%;
            height: 100%;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
            padding-top: 140px; /* Space for fixed header */
        }

        .map-wrapper {
            transform-origin: center center;
            transition: transform 0.1s ease-out;
            cursor: grab;
        }
        .map-wrapper:active {
            cursor: grabbing;
        }

        .map {
            position: relative;
            width: 1800px;
            height: 1850px;
        }

        /* Zoom controls */
        .zoom-controls {
            position: fixed;
            bottom: 20px;
            right: 20px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            z-index: 600;
        }
        .zoom-btn {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            border: 1px solid rgba(212, 175, 55, 0.3);
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: #d4af37;
            font-size: 1.5rem;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
            transition: all 0.2s ease;
        }
        .zoom-btn:hover {
            background: linear-gradient(135deg, #16213e 0%, #1a1a2e 100%);
            border-color: rgba(212, 175, 55, 0.6);
            transform: scale(1.05);
        }
        .zoom-btn:active {
            transform: scale(0.95);
        }
        .zoom-level {
            text-align: center;
            font-size: 0.7rem;
            color: #888;
            font-family: monospace;
        }

        /* ============================================
           HOUSE BLOCKS (diamond-shaped backgrounds)
           ============================================ */
        .house-block {
            position: absolute;
            transform: rotate(45deg);
            border-radius: 8px;
            opacity: 0.9;
        }

        /* House colors - Darker/richer versions to offset from card elemental designators */
        .house-block.spirit { background: #8A2F2F; }      /* Dark Red - Fire */
        .house-block.mind { background: #2E5B2E; }        /* Dark Green - Air */
        .house-block.emotion { background: #2A4A6B; }     /* Dark Blue - Water */
        .house-block.body { background: #5C4728; }        /* Dark Brown - Earth */

        /* ============================================
           GESTALT CENTER (solid purple - Quintessence)
           ============================================ */
        .gestalt-block {
            position: absolute;
            border-radius: 8px;
            overflow: hidden;
            transform: rotate(0deg);  /* Axis-aligned, not rotated */
            background: #47335C;  /* Dark Purple - Quintessence */
        }

        /* ============================================
           CARDS
           ============================================ */
        .card {
            position: absolute;
            cursor: pointer;
            transition: transform 0.2s ease, z-index 0.2s, opacity 0.4s ease;
            isolation: isolate;  /* Create stacking context for element-bg */
        }
        /* Training mode: cards start hidden and fade in */
        .card.hidden {
            opacity: 0;
            pointer-events: none;
        }
        .card.revealed {
            opacity: 1;
            pointer-events: auto;
        }

        /* Narration text for training mode */
        .narration {
            position: absolute;
            left: 50%;
            top: 52%;
            transform: translate(-50%, -50%);
            font-family: 'Cormorant Garamond', serif;
            font-size: 2.5rem;
            font-weight: 300;
            color: rgba(255, 255, 255, 0.95);
            text-align: center;
            max-width: 600px;
            line-height: 1.4;
            letter-spacing: 0.05em;
            text-shadow: 0 2px 20px rgba(0, 0, 0, 0.9), 0 0 60px rgba(0, 0, 0, 0.8);
            opacity: 0;
            transition: opacity 0.8s ease;
            pointer-events: none;
            z-index: 500;
        }
        .narration.visible {
            opacity: 1;
        }
        .card:hover {
            z-index: 200;
        }
        .card.portal:hover,
        .card.archetype:hover {
            transform: scale(1.3);
        }
        /* Bounds/agents use CSS variable for rotation */
        .card.bound,
        .card.agent {
            transform: rotate(var(--card-rotation, 0deg));
        }
        .card.bound:hover,
        .card.agent:hover {
            transform: rotate(var(--card-rotation, 0deg)) scale(1.3);
        }
        .card img {
            display: block;  /* Remove inline baseline spacing */
            width: 100%;
            border-radius: 4px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }

        /* Elemental designator background */
        .card .element-bg {
            position: absolute;
            inset: -6px;
            border-radius: 8px;
            z-index: -1;
            opacity: 0.85;
        }
        .card.archetype .element-bg,
        .card.portal .element-bg {
            box-shadow: 0 2px 12px rgba(0,0,0,0.4);
        }
        .card.bound .element-bg,
        .card.agent .element-bg {
            inset: -4px;
            border-radius: 6px;
            box-shadow: 0 1px 6px rgba(0,0,0,0.3);
        }

        /* Card sizes */
        .card.portal { width: 120px; }  /* Same as archetypes */
        .card.archetype { width: 120px; }
        .card.bound { width: 45px; }
        .card.agent { width: 50px; }

        /* ============================================
           LABELS
           ============================================ */
        .label {
            position: absolute;
            font-family: 'Cormorant Garamond', serif;
            color: #555;
            letter-spacing: 0.1em;
            pointer-events: none;
        }
        .label.title {
            font-size: 4rem;
            font-weight: 300;
            letter-spacing: 0.15em;
            color: #445;
        }
        .label.house-name {
            font-size: 1.6rem;
            text-transform: uppercase;
            letter-spacing: 0.25em;
            text-shadow: 0 2px 8px rgba(0,0,0,0.9);
            text-align: center;
            font-weight: 400;
        }
        /* House-specific label colors - lighter versions of house backgrounds */
        .label.house-name.spirit { color: #E88B8B; }   /* Light Red */
        .label.house-name.mind { color: #7DC77D; }     /* Light Green */
        .label.house-name.emotion { color: #6BA3D6; }  /* Light Blue */
        .label.house-name.body { color: #D4B577; }     /* Light Brown/Tan */
        .label.house-name.gestalt { color: #B89BD8; }  /* Light Purple */

        /* Rainbow color cycling - matches main reader */
        @keyframes rainbow-cycle {
            0%, 100% { color: #f0f0f0; }
            10% { color: #a78bfa; }
            20% { color: #818cf8; }
            30% { color: #60a5fa; }
            40% { color: #38bdf8; }
            50% { color: #2dd4bf; }
            60% { color: #4ade80; }
            70% { color: #a3e635; }
            80% { color: #facc15; }
            90% { color: #fb923c; }
        }

        /* Per-letter rainbow animation */
        .rainbow-letter {
            animation: rainbow-cycle 16s ease-in-out infinite;
            display: inline-block;
        }
        .rainbow-letter-0 { animation-delay: 0s; }
        .rainbow-letter-1 { animation-delay: -1s; }
        .rainbow-letter-2 { animation-delay: -2s; }
        .rainbow-letter-3 { animation-delay: -3s; }
        .rainbow-letter-4 { animation-delay: -4s; }
        .rainbow-letter-5 { animation-delay: -5s; }
        .rainbow-letter-6 { animation-delay: -6s; }
        .rainbow-letter-7 { animation-delay: -7s; }
        .rainbow-letter-8 { animation-delay: -8s; }
        .rainbow-letter-9 { animation-delay: -9s; }
        .rainbow-letter-10 { animation-delay: -10s; }

        /* Top header - matches main site */
        .page-header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            text-align: center;
            z-index: 500;
            padding: 1.5rem 0;
            background: rgba(24, 24, 27, 0.6);
            backdrop-filter: blur(4px);
            border-bottom: 1px solid rgba(63, 63, 70, 0.3);
        }
        .page-header h1 {
            font-family: system-ui, -apple-system, sans-serif;
            font-size: 1.5rem;
            font-weight: 200;
            letter-spacing: 0.3em;
            text-transform: uppercase;
            margin: 0;
        }
        .page-header h1 a {
            color: inherit;
            text-decoration: none;
        }
        .page-header h1 a:hover {
            opacity: 0.8;
        }
        .page-header .subtitle {
            font-family: system-ui, -apple-system, sans-serif;
            font-size: 0.875rem;
            color: #d4d4d8;
            letter-spacing: 0.05em;
            margin-top: 2px;
            font-weight: 300;
        }
        .page-header .version {
            font-size: 0.625rem;
            color: #71717a;
            margin-top: 2px;
        }
        .nav-links {
            display: flex;
            justify-content: center;
            gap: 0.5rem;
            margin-top: 0.75rem;
            font-size: 0.75rem;
        }
        .nav-links a {
            padding: 0.375rem 0.75rem;
            border-radius: 0.25rem;
            background: rgba(24, 24, 27, 0.9);
            border: 1px solid rgba(82, 82, 91, 0.6);
            color: #d4d4d8;
            text-decoration: none;
            transition: all 0.2s ease;
            font-family: system-ui, -apple-system, sans-serif;
        }
        .nav-links a:hover {
            border-color: rgba(var(--hover-color), 0.5);
            color: rgb(var(--hover-color));
        }
        .nav-links a.nav-reader:hover { --hover-color: 251, 113, 133; }  /* rose-400 - position 1 */
        .nav-links a.nav-community:hover { --hover-color: 251, 191, 36; }  /* amber-400 - position 2 */
        .nav-links a.nav-guide:hover { --hover-color: 52, 211, 153; }  /* emerald-400 - position 3 */
        .nav-links a.nav-about:hover { --hover-color: 34, 211, 238; }  /* cyan-400 - position 4 */
        .nav-links a.nav-lounge:hover { --hover-color: 139, 92, 246; }  /* violet-400 - position 5 */
        .nav-links a.nav-council:hover { --hover-color: 232, 121, 249; }  /* fuchsia-400 - position 6 */

        /* Card name labels - white rounded boxes on the card */
        .card-label {
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            font-family: 'Cormorant Garamond', serif;
            text-align: center;
            pointer-events: none;
            white-space: nowrap;
            background: rgba(255, 255, 255, 0.7);
            border-radius: 3px;
            padding: 1px 4px;
            color: #333;
        }
        .card.archetype .card-label,
        .card.portal .card-label {
            bottom: 6px;
            font-size: 0.6rem;
            letter-spacing: 0.03em;
            padding: 2px 6px;
            border-radius: 4px;
        }
        .card.bound .card-label {
            bottom: 3px;
            font-size: 0.4rem;
            font-weight: 600;
            padding: 1px 3px;
        }
        .card.agent .card-label {
            bottom: 3px;
            font-size: 0.35rem;
            text-transform: uppercase;
            letter-spacing: 0.02em;
            padding: 1px 3px;
        }

        /* ============================================
           INFO MODAL (card details panel)
           ============================================ */
        .info-modal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.85);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        .info-modal.active { display: flex; }
        .info-panel {
            background: #18181b;
            border: 1px solid #3f3f46;
            border-radius: 12px;
            max-width: 400px;
            width: 100%;
            max-height: 85vh;
            overflow-y: auto;
            padding: 20px;
        }
        .info-panel-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 16px;
        }
        .info-panel-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: #f4f4f5;
            margin: 0;
        }
        .info-panel-trad {
            font-size: 0.875rem;
            color: #71717a;
            margin-top: 2px;
        }
        .info-panel-close {
            color: #71717a;
            font-size: 1.5rem;
            cursor: pointer;
            line-height: 1;
            padding: 0 4px;
        }
        .info-panel-close:hover { color: #d4d4d8; }
        .info-panel-image {
            width: 100%;
            border-radius: 8px;
            cursor: pointer;
            margin-bottom: 16px;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .info-panel-image:hover {
            transform: scale(1.02);
            box-shadow: 0 4px 20px rgba(212, 175, 55, 0.3);
        }
        .info-panel-badge {
            display: inline-block;
            font-size: 0.75rem;
            padding: 4px 10px;
            border-radius: 9999px;
            margin-bottom: 12px;
        }
        .info-panel-badge.archetype { background: rgba(245, 158, 11, 0.2); color: #fbbf24; }
        .info-panel-badge.bound { background: rgba(59, 130, 246, 0.2); color: #60a5fa; }
        .info-panel-badge.agent { background: rgba(139, 92, 246, 0.2); color: #a78bfa; }
        .info-panel-channel {
            font-size: 0.75rem;
            color: #71717a;
            margin-left: 8px;
        }
        .info-panel-desc {
            font-size: 0.875rem;
            color: #d4d4d8;
            line-height: 1.6;
        }
        .info-panel-hint {
            font-size: 0.7rem;
            color: #52525b;
            text-align: center;
            margin-top: 16px;
            font-style: italic;
        }
        /* Navigation back button */
        .info-panel-nav {
            margin-bottom: 12px;
        }
        .info-back-btn {
            background: transparent;
            border: 1px solid #3f3f46;
            color: #a1a1aa;
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-family: 'Cormorant Garamond', serif;
            font-size: 0.85rem;
            transition: all 0.2s ease;
        }
        .info-back-btn:hover {
            border-color: #d4af37;
            color: #d4af37;
        }
        /* Archetype metadata section */
        .info-archetype-meta {
            background: rgba(255, 255, 255, 0.03);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 16px;
        }
        .meta-row {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 6px;
        }
        .meta-row:last-child { margin-bottom: 0; }
        .meta-label {
            font-size: 0.75rem;
            color: #71717a;
            min-width: 65px;
        }
        .meta-value {
            font-size: 0.85rem;
            color: #d4d4d8;
        }
        .meta-value.clickable {
            color: #d4af37;
            cursor: pointer;
            text-decoration: underline;
            text-decoration-style: dotted;
            text-underline-offset: 3px;
        }
        .meta-value.clickable:hover {
            color: #fbbf24;
            text-decoration-style: solid;
        }
        /* Associated archetype section */
        .info-associated {
            background: linear-gradient(135deg, rgba(212, 175, 55, 0.08) 0%, rgba(212, 175, 55, 0.02) 100%);
            border: 1px solid rgba(212, 175, 55, 0.2);
            border-radius: 8px;
            padding: 14px;
            margin-top: 16px;
            margin-bottom: 12px;
        }
        .associated-header {
            font-size: 0.7rem;
            color: #71717a;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            margin-bottom: 10px;
        }
        .associated-card {
            margin-bottom: 10px;
        }
        .associated-name {
            font-size: 1rem;
            font-weight: 600;
            color: #d4af37;
            cursor: pointer;
            display: block;
            margin-bottom: 4px;
        }
        .associated-name:hover {
            color: #fbbf24;
            text-decoration: underline;
        }
        .associated-desc {
            font-size: 0.8rem;
            color: #a1a1aa;
            line-height: 1.5;
        }
        .associated-meta {
            display: flex;
            flex-wrap: wrap;
            gap: 6px 16px;
            font-size: 0.75rem;
            padding-top: 10px;
            border-top: 1px solid rgba(212, 175, 55, 0.1);
        }
        .associated-meta .meta-label {
            min-width: auto;
        }
        .associated-meta .meta-value {
            font-size: 0.75rem;
        }

        /* ============================================
           FULLSCREEN IMAGE MODAL
           ============================================ */
        .fullscreen-modal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.95);
            z-index: 1100;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            cursor: pointer;
        }
        .fullscreen-modal.active { display: flex; }
        .fullscreen-modal img {
            max-width: 90%;
            max-height: 85%;
            border-radius: 8px;
            box-shadow: 0 8px 40px rgba(0,0,0,0.5);
        }
        .fullscreen-title {
            margin-top: 20px;
            font-size: 1.5rem;
            color: #d4af37;
            letter-spacing: 0.2em;
            text-transform: uppercase;
        }
        .fullscreen-sub {
            font-size: 0.9rem;
            color: #888;
            margin-top: 8px;
        }

        /* ============================================
           DEV MODE - Draggable elements
           ============================================ */
        .dev-panel {
            position: fixed;
            top: 10px;
            right: 10px;
            background: rgba(0,0,0,0.85);
            color: #fff;
            padding: 15px;
            border-radius: 8px;
            font-family: monospace;
            font-size: 12px;
            z-index: 500;
            max-height: 90vh;
            overflow-y: auto;
            min-width: 280px;
        }
        .dev-panel h3 {
            margin: 0 0 10px 0;
            color: #d4af37;
            font-size: 14px;
        }
        .dev-panel .coord-line {
            margin: 4px 0;
            padding: 4px;
            background: rgba(255,255,255,0.1);
            border-radius: 3px;
        }
        .dev-panel button {
            margin-top: 10px;
            padding: 8px 12px;
            background: #d4af37;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
        }
        .dev-panel button:hover {
            background: #e5c048;
        }
        .dev-toggle {
            position: fixed;
            top: 10px;
            left: 10px;
            background: #333;
            color: #fff;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            z-index: 500;
            font-family: monospace;
        }
        .dev-toggle:hover {
            background: #555;
        }

        /* Background controls panel */
        .bg-controls-toggle {
            position: fixed;
            top: 12px;
            left: 12px;
            z-index: 600;
            width: 32px;
            height: 32px;
            border-radius: 8px;
            background: rgba(24, 24, 27, 0.8);
            border: 1px solid rgba(82, 82, 91, 0.5);
            color: #a1a1aa;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            backdrop-filter: blur(4px);
        }
        .bg-controls-toggle:hover {
            color: #d4d4d8;
            background: rgba(39, 39, 42, 0.9);
        }
        .bg-controls-panel {
            position: fixed;
            top: 56px;
            left: 12px;
            z-index: 600;
            width: 280px;
            background: rgba(24, 24, 27, 0.95);
            border: 1px solid rgba(82, 82, 91, 0.5);
            border-radius: 12px;
            backdrop-filter: blur(8px);
            box-shadow: 0 8px 32px rgba(0,0,0,0.4);
            display: none;
            font-family: system-ui, -apple-system, sans-serif;
        }
        .bg-controls-panel.visible {
            display: block;
        }
        .bg-controls-header {
            padding: 12px 16px;
            border-bottom: 1px solid rgba(63, 63, 70, 0.5);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .bg-controls-header h3 {
            font-size: 0.875rem;
            font-weight: 500;
            color: #e4e4e7;
            margin: 0;
        }
        .bg-controls-close {
            background: none;
            border: none;
            color: #71717a;
            cursor: pointer;
            padding: 4px;
            font-size: 1rem;
        }
        .bg-controls-close:hover {
            color: #d4d4d8;
        }
        .bg-controls-content {
            padding: 16px;
        }
        .bg-control-row {
            margin-bottom: 16px;
        }
        .bg-control-row:last-child {
            margin-bottom: 0;
        }
        .bg-control-label {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            font-size: 0.75rem;
            color: #71717a;
        }
        .bg-control-value {
            color: #a1a1aa;
        }
        .bg-slider {
            width: 100%;
            height: 4px;
            background: #3f3f46;
            border-radius: 2px;
            appearance: none;
            cursor: pointer;
        }
        .bg-slider::-webkit-slider-thumb {
            appearance: none;
            width: 14px;
            height: 14px;
            background: #f59e0b;
            border-radius: 50%;
            cursor: pointer;
        }

        /* Background controls toggle button */
        .bg-controls-toggle {
            position: fixed;
            top: 120px;
            left: 12px;
            z-index: 500;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(24, 24, 27, 0.9);
            border: 1px solid rgba(82, 82, 91, 0.5);
            border-radius: 8px;
            color: #a1a1aa;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .bg-controls-toggle:hover {
            color: #f59e0b;
            border-color: rgba(245, 158, 11, 0.5);
        }

        /* Legacy bg-toggle for backwards compat */
        .bg-toggle-container { display: none; }
        .bg-toggle {
            position: relative;
            width: 36px;
            height: 20px;
            appearance: none;
            background: rgba(30, 30, 40, 0.8);
            border-radius: 10px;
            border: 1px solid rgba(212, 175, 55, 0.3);
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .bg-toggle:checked {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            border-color: rgba(212, 175, 55, 0.5);
        }
        .bg-toggle::before {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            width: 14px;
            height: 14px;
            border-radius: 50%;
            background: #888;
            transition: all 0.2s ease;
        }
        .bg-toggle:checked::before {
            left: 18px;
            background: #d4af37;
        }

        body.dev-mode .card.bound,
        body.dev-mode .card.agent {
            cursor: move;
            outline: 2px dashed rgba(255,255,255,0.3);
        }
        body.dev-mode .card.bound:hover,
        body.dev-mode .card.agent:hover {
            outline-color: #00ff00;
        }

    </style>
</head>
<body>
    <!-- Video background -->
    <video class="video-background" autoplay muted loop playsinline>
        <source src="/video/cosmos.mp4" type="video/mp4">
    </video>

    <!-- Page header with navigation -->
    <div class="page-header">
        <h1 class="nirmanakaya-title">
            <span class="rainbow-letter rainbow-letter-0">N</span><span class="rainbow-letter rainbow-letter-1">I</span><span class="rainbow-letter rainbow-letter-2">R</span><span class="rainbow-letter rainbow-letter-3">M</span><span class="rainbow-letter rainbow-letter-4">A</span><span class="rainbow-letter rainbow-letter-5">N</span><span class="rainbow-letter rainbow-letter-6">A</span><span class="rainbow-letter rainbow-letter-7">K</span><span class="rainbow-letter rainbow-letter-8">A</span><span class="rainbow-letter rainbow-letter-9">Y</span><span class="rainbow-letter rainbow-letter-10">A</span>
        </h1>
        <div class="subtitle">The 78 Signatures</div>
        <nav class="nav-links">
            <a href="/" class="nav-reader">Reader</a>
            <a href="/hub" class="nav-community">Community</a>
            <a href="/guide" class="nav-guide">Guide</a>
            <a href="/about" class="nav-about">About</a>
            <a href="/lounge" class="nav-lounge">Lounge</a>
            <a href="/council" class="nav-council">Council</a>
        </nav>
    </div>

    <!-- Background controls toggle button -->
    <button class="bg-controls-toggle" id="bg-controls-toggle" title="Background Settings">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
        </svg>
    </button>

    <!-- Background controls panel -->
    <div class="bg-controls-panel" id="bg-controls-panel">
        <div class="bg-controls-header">
            <h3>Background</h3>
            <button class="bg-controls-close" id="bg-controls-close">×</button>
        </div>
        <div class="bg-controls-content">
            <div class="bg-control-row">
                <div class="bg-control-label">
                    <span>Opacity</span>
                    <span class="bg-control-value" id="opacity-value">40%</span>
                </div>
                <input type="range" class="bg-slider" id="opacity-slider" min="0" max="100" value="40">
            </div>
            <div class="bg-control-row">
                <div class="bg-control-label">
                    <span>Blur</span>
                    <span class="bg-control-value" id="blur-value">0px</span>
                </div>
                <input type="range" class="bg-slider" id="blur-slider" min="0" max="20" value="0">
            </div>
            <div class="bg-control-row">
                <div class="bg-control-label">
                    <span>Video</span>
                    <span class="bg-control-value">
                        <input type="checkbox" id="video-toggle" checked style="cursor: pointer;">
                    </span>
                </div>
            </div>
        </div>
    </div>

    <div class="canvas-container" id="canvas-container">
        <div class="map-wrapper" id="map-wrapper">
            <div class="map" id="map">
                <div class="narration" id="narration"></div>
            </div>
        </div>
    </div>

    <!-- Zoom controls -->
    <div class="zoom-controls">
        <button class="zoom-btn" onclick="zoomIn()" title="Zoom in">+</button>
        <div class="zoom-level" id="zoom-level">100%</div>
        <button class="zoom-btn" onclick="zoomOut()" title="Zoom out">−</button>
        <button class="zoom-btn" onclick="zoomFit()" title="Fit to screen" style="font-size: 1rem;">⊡</button>
        <button class="zoom-btn" onclick="startRevealSequence()" title="Play reveal sequence" style="font-size: 1rem; margin-top: 12px;">▶</button>
    </div>

    <!-- Info Modal (card details with navigation) -->
    <div class="info-modal" id="info-modal" onclick="closeInfoModal()">
        <div class="info-panel" onclick="event.stopPropagation()">
            <!-- Back button (shown when there's history) -->
            <div class="info-panel-nav" id="info-nav" style="display: none;">
                <button class="info-back-btn" onclick="navigateBack()">← Back</button>
            </div>
            <div class="info-panel-header">
                <div>
                    <h3 class="info-panel-title" id="info-title"></h3>
                    <p class="info-panel-trad" id="info-trad"></p>
                </div>
                <span class="info-panel-close" onclick="closeInfoModal()">×</span>
            </div>
            <img class="info-panel-image" id="info-img" src="" onclick="openFullscreen()" title="Click for full-size image">
            <div class="info-panel-meta">
                <span class="info-panel-badge" id="info-badge"></span>
                <span class="info-panel-channel" id="info-channel"></span>
            </div>
            <!-- Archetype metadata (for archetypes) -->
            <div class="info-archetype-meta" id="info-archetype-meta" style="display: none;">
                <div class="meta-row">
                    <span class="meta-label">House:</span>
                    <span class="meta-value clickable" id="info-house"></span>
                </div>
                <div class="meta-row">
                    <span class="meta-label">Process:</span>
                    <span class="meta-value" id="info-process"></span>
                </div>
                <div class="meta-row" id="info-channel-row" style="display: none;">
                    <span class="meta-label">Channel:</span>
                    <span class="meta-value clickable" id="info-arch-channel"></span>
                </div>
            </div>
            <p class="info-panel-desc" id="info-desc"></p>
            <!-- Associated archetype section (for bounds/agents) -->
            <div class="info-associated" id="info-associated" style="display: none;">
                <div class="associated-header" id="associated-header">Expresses</div>
                <div class="associated-card">
                    <span class="associated-name clickable" id="associated-name"></span>
                    <span class="associated-desc" id="associated-desc"></span>
                </div>
                <div class="associated-meta">
                    <span class="meta-label">House:</span>
                    <span class="meta-value" id="associated-house"></span>
                    <span class="meta-label">Process:</span>
                    <span class="meta-value" id="associated-process"></span>
                    <span class="meta-label">Channel:</span>
                    <span class="meta-value" id="associated-channel"></span>
                </div>
            </div>
            <p class="info-panel-hint">Click image to view full-size</p>
        </div>
    </div>

    <!-- Fullscreen Image Modal -->
    <div class="fullscreen-modal" id="fullscreen-modal" onclick="closeFullscreen()">
        <img id="fullscreen-img" src="">
        <div class="fullscreen-title" id="fullscreen-title"></div>
        <div class="fullscreen-sub" id="fullscreen-sub"></div>
    </div>

<script>
// ============================================
// CONFIGURATION
// ============================================
const CONFIG = {
    mapWidth: 1800,
    mapHeight: 1650,

    // Card sizes
    portalSize: 120,  // Same as archetypes
    archetypeSize: 120,
    boundSize: 45,
    agentSize: 50,

    // House diamond size
    houseSize: 280,
};

const cx = CONFIG.mapWidth / 2;  // Center X

// ============================================
// DATA - Archetype names and traditional correspondences
// ============================================
const ARCHETYPES = {
    0: { name: 'Potential', trad: 'The Fool', channel: null, desc: 'The seed state of all becoming. Not naivety but infinite potential — the moment before choice collapses possibility into actuality. Contains everything, committed to nothing yet.' },
    1: { name: 'Will', trad: 'The Magician', channel: null, desc: 'The capacity to direct attention and energy toward chosen ends. Not force but focused intention — the ability to say "this, not that" and mean it.' },
    2: { name: 'Wisdom', trad: 'The High Priestess', channel: 'Cognition', desc: "Deep knowing that precedes analysis. The capacity to recognize what matters before understanding why. Wisdom isn't accumulated knowledge — it's seeing through to essence." },
    3: { name: 'Nurturing', trad: 'The Empress', channel: 'Structure', desc: 'Tending what needs to develop. Creating conditions for growth without forcing outcomes. The patient attention that allows emergence.' },
    4: { name: 'Order', trad: 'The Emperor', channel: 'Intent', desc: 'The impulse to organize chaos into workable form. Not rigid control but functional architecture — creating containers that allow complexity to be navigated.' },
    5: { name: 'Culture', trad: 'The Hierophant', channel: 'Resonance', desc: 'The transmission of meaning across time and between people. Rituals, languages, practices that carry wisdom forward. Living connection to what has proven valuable.' },
    6: { name: 'Compassion', trad: 'The Lovers', channel: 'Resonance', desc: 'The capacity to feel with rather than just about. Genuine alignment between beings that recognizes shared experience. Connection that honors difference.' },
    7: { name: 'Drive', trad: 'The Chariot', channel: 'Intent', desc: 'Energy channeled toward destination. Not aggression but focused motion — the capacity to maintain direction through resistance without being consumed.' },
    8: { name: 'Fortitude', trad: 'Strength', channel: 'Structure', desc: 'The ability to bear what must be borne. Not hardness but resilient strength — capacity to hold form under pressure without breaking or becoming rigid.' },
    9: { name: 'Discipline', trad: 'The Hermit', channel: 'Cognition', desc: "Solitary cultivation of capacity through repetition. The hermit's lamp illuminates through sustained attention, not flash. Intention transformed into embodied skill." },
    10: { name: 'Source', trad: 'Wheel of Fortune', channel: null, desc: "The turning point where what was outside enters the system. Not fate but timing — recognizing what's arriving and how to meet it." },
    11: { name: 'Equity', trad: 'Justice', channel: 'Resonance', desc: "Right relationship made manifest. Not punishment but recalibration — adjusting what's out of proportion until balance returns." },
    12: { name: 'Sacrifice', trad: 'The Hanged Man', channel: 'Intent', desc: 'Conscious letting go of what no longer serves. Not loss but clearing — creating space by releasing grip. Revealing value hidden by habitual grasping.' },
    13: { name: 'Change', trad: 'Death', channel: 'Structure', desc: 'The completion that allows new beginning. Not destruction but transformation — the moment when what was must fully end for what will be to emerge.' },
    14: { name: 'Balance', trad: 'Temperance', channel: 'Cognition', desc: 'Continuous adjustment that maintains flow. Not static middle but active calibration — sensing when to add, when to subtract, how to blend.' },
    15: { name: 'Abstraction', trad: 'The Devil', channel: 'Cognition', desc: 'Recognition of pattern stripped of content. Not temptation but clarity about mechanism — seeing how things work beneath surface appearance.' },
    16: { name: 'Breakthrough', trad: 'The Tower', channel: 'Structure', desc: "Rapid dissolution of what couldn't hold. Not catastrophe but liberation — structures built on false premises collapse when truth arrives." },
    17: { name: 'Inspiration', trad: 'The Star', channel: 'Intent', desc: "The draw toward what's genuinely desired. Not fantasy but orientation — knowing which star to steer by. Recognized, not given; remembered, not arrived." },
    18: { name: 'Imagination', trad: 'The Moon', channel: 'Resonance', desc: 'Capacity to move through uncertainty without forcing clarity. The moon illuminates enough to walk, not enough to see everything. Trust the path that reveals itself.' },
    19: { name: 'Actualization', trad: 'The Sun', channel: null, desc: 'Full expression of inherent nature. Not achievement but authenticity — allowing what you are to shine without dimming or distortion.' },
    20: { name: 'Awareness', trad: 'Judgement', channel: null, desc: "The capacity to perceive from outside the system while remaining within it. Not judgment but recognition — seeing what's true across all layers." },
    21: { name: 'Creation', trad: 'The World', channel: null, desc: 'The point of departure that is also arrival. Full integration that allows release into next becoming. Completion that opens rather than closes.' }
};

// Elemental Designator Colors (channel → element → color)
const ELEMENT_COLORS = {
    Intent: '#C44444',      // Fire - Red
    Cognition: '#4A8B4A',   // Air - Green
    Resonance: '#3D6A99',   // Water - Blue
    Structure: '#8B6B3D',   // Earth - Brown
    null: '#6B4D8A'         // Quintessence - Purple (Gestalt/Portal)
};

// Gestalt archetypes govern peripheral houses - use their governing house's channel
const GESTALT_ARCHETYPE_CHANNELS = {
    0: 'Intent',      // Potential (Fool) governs Spirit → Fire/Red
    1: 'Structure',   // Will (Magician) governs Body → Earth/Brown
    19: 'Cognition',  // Revelation (Sun) governs Mind → Air/Green
    20: 'Resonance'   // Awareness (Judgement) governs Emotion → Water/Blue
};

// Bounds data (numeric cards) - matches lib/archetypes.js
const BOUNDS = {
    // Intent Channel (Wands)
    22: { name: 'Activation', trad: 'Ace of Wands', channel: 'Intent', number: 1, archetype: 0, desc: 'Beginning of pure potential through Intent. The spark before direction.' },
    23: { name: 'Orientation', trad: '2 of Wands', channel: 'Intent', number: 2, archetype: 17, desc: 'Decisive direction through aspiration. Choosing which star to steer by.' },
    24: { name: 'Assertion', trad: '3 of Wands', channel: 'Intent', number: 3, archetype: 4, desc: 'Primal claim of structure through Intent. Expansive declaration outward.' },
    25: { name: 'Alignment', trad: '4 of Wands', channel: 'Intent', number: 4, archetype: 7, desc: 'Peaceful momentum, stable drive. Intent finding its natural rhythm.' },
    26: { name: 'Dedication', trad: '5 of Wands', channel: 'Intent', number: 5, archetype: 12, desc: 'Internal practical release through Intent. Testing commitment through engagement.' },
    27: { name: 'Recognition', trad: '6 of Wands', channel: 'Intent', number: 6, archetype: 12, desc: 'External acknowledgment of sacrifice. Intent visible and honored.' },
    28: { name: 'Resolve', trad: '7 of Wands', channel: 'Intent', number: 7, archetype: 7, desc: 'Gathered determination, harvested momentum. Defending chosen direction.' },
    29: { name: 'Command', trad: '8 of Wands', channel: 'Intent', number: 8, archetype: 4, desc: 'Deep authority, threshold structure. Intent moving with unstoppable clarity.' },
    30: { name: 'Resilience', trad: '9 of Wands', channel: 'Intent', number: 9, archetype: 17, desc: 'Abundant persistence through aspiration. Strength from continued hoping.' },
    31: { name: 'Realization', trad: '10 of Wands', channel: 'Intent', number: 10, archetype: 0, desc: 'Completion of potential through Intent. Carrying what pure possibility became.' },
    // Cognition Channel (Swords)
    32: { name: 'Perception', trad: 'Ace of Swords', channel: 'Cognition', number: 1, archetype: 19, desc: 'Beginning of clear seeing. The first cut of clarity arising.' },
    33: { name: 'Reflection', trad: '2 of Swords', channel: 'Cognition', number: 2, archetype: 2, desc: 'Decisive inner knowing. Mind holding truth before declaring it.' },
    34: { name: 'Calculation', trad: '3 of Swords', channel: 'Cognition', number: 3, archetype: 15, desc: 'Primal analysis, expansive thought. Pattern recognition at work.' },
    35: { name: 'Repose', trad: '4 of Swords', channel: 'Cognition', number: 4, archetype: 14, desc: 'Peaceful stability through cognition. Mind at rest, calibrating.' },
    36: { name: 'Discernment', trad: '5 of Swords', channel: 'Cognition', number: 5, archetype: 9, desc: 'Internal practical cognition. Refining perception through careful distinction.' },
    37: { name: 'Guidance', trad: '6 of Swords', channel: 'Cognition', number: 6, archetype: 9, desc: 'External direction through discipline. Mind finding passage, showing the way.' },
    38: { name: 'Reconciliation', trad: '7 of Swords', channel: 'Cognition', number: 7, archetype: 14, desc: 'Gathering thoughts into alignment. Strategic mental integration.' },
    39: { name: 'Immersion', trad: '8 of Swords', channel: 'Cognition', number: 8, archetype: 15, desc: 'Deep threshold of abstraction. Mind exploring its own depths.' },
    40: { name: 'Plurality', trad: '9 of Swords', channel: 'Cognition', number: 9, archetype: 2, desc: 'Abundant knowing, many truths held. The fullness of perception.' },
    41: { name: 'Clarity', trad: '10 of Swords', channel: 'Cognition', number: 10, archetype: 19, desc: 'Completion of cognition. Full seeing, nothing hidden.' },
    // Resonance Channel (Cups)
    42: { name: 'Receptivity', trad: 'Ace of Cups', channel: 'Resonance', number: 1, archetype: 20, desc: 'Beginning of felt awareness. Heart open, ready to receive.' },
    43: { name: 'Merge', trad: '2 of Cups', channel: 'Resonance', number: 2, archetype: 18, desc: 'Decisive connection through vision. Two becoming one flow.' },
    44: { name: 'Celebration', trad: '3 of Cups', channel: 'Resonance', number: 3, archetype: 5, desc: 'Primal joy through shared meaning. Community in celebration.' },
    45: { name: 'Reverie', trad: '4 of Cups', channel: 'Resonance', number: 4, archetype: 6, desc: 'Peaceful connection, stable feeling. Sitting with what the heart knows.' },
    46: { name: 'Reckoning', trad: '5 of Cups', channel: 'Resonance', number: 5, archetype: 11, desc: 'Internal accounting of fairness. The private felt-sense of what is owed.' },
    47: { name: 'Reciprocity', trad: '6 of Cups', channel: 'Resonance', number: 6, archetype: 11, desc: 'External fair exchange. Giving and receiving in balance.' },
    48: { name: 'Allure', trad: '7 of Cups', channel: 'Resonance', number: 7, archetype: 6, desc: 'Gathering emotional possibilities. The pull of what might be felt.' },
    49: { name: 'Passage', trad: '8 of Cups', channel: 'Resonance', number: 8, archetype: 5, desc: 'Deep threshold of shared meaning. Walking toward what connects.' },
    50: { name: 'Fulfillment', trad: '9 of Cups', channel: 'Resonance', number: 9, archetype: 18, desc: 'Abundant vision realized. Deep satisfaction in what was imagined.' },
    51: { name: 'Completion', trad: '10 of Cups', channel: 'Resonance', number: 10, archetype: 20, desc: 'Emotional wholeness achieved. Full awareness of felt connection.' },
    // Structure Channel (Pentacles)
    52: { name: 'Initiation', trad: 'Ace of Pentacles', channel: 'Structure', number: 1, archetype: 1, desc: 'Beginning of directed form. The seed of what will be built.' },
    53: { name: 'Flow', trad: '2 of Pentacles', channel: 'Structure', number: 2, archetype: 3, desc: 'Decisive cultivation through form. Balancing what grows with grace.' },
    54: { name: 'Formation', trad: '3 of Pentacles', channel: 'Structure', number: 3, archetype: 16, desc: 'Primal structure emerging. Skilled work building something new.' },
    55: { name: 'Preservation', trad: '4 of Pentacles', channel: 'Structure', number: 4, archetype: 13, desc: 'Peaceful stability through form. Holding what transformation produced.' },
    56: { name: 'Steadfastness', trad: '5 of Pentacles', channel: 'Structure', number: 5, archetype: 8, desc: 'Internal practical strength. Persisting through material pressure.' },
    57: { name: 'Support', trad: '6 of Pentacles', channel: 'Structure', number: 6, archetype: 8, desc: 'External strength shared. Resources flowing where needed.' },
    58: { name: 'Harvest', trad: '7 of Pentacles', channel: 'Structure', number: 7, archetype: 13, desc: 'Gathering what transformation grew. Patient waiting rewarded.' },
    59: { name: 'Commitment', trad: '8 of Pentacles', channel: 'Structure', number: 8, archetype: 16, desc: 'Deep threshold of new structure. Dedicated craft, persistent building.' },
    60: { name: 'Flourishing', trad: '9 of Pentacles', channel: 'Structure', number: 9, archetype: 3, desc: 'Abundant growth achieved. Enjoying what careful tending produced.' },
    61: { name: 'Achievement', trad: '10 of Pentacles', channel: 'Structure', number: 10, archetype: 1, desc: 'Completion of directed form. Legacy established through sustained will.' }
};

// Agents data (court cards) - matches lib/archetypes.js
const AGENTS = {
    62: { name: 'Initiate of Intent', trad: 'Page of Wands', channel: 'Intent', role: 'Initiate', archetype: 17, desc: 'Fresh enthusiasm for new direction. The spark before it knows where it is going.' },
    63: { name: 'Catalyst of Intent', trad: 'Knight of Wands', channel: 'Intent', role: 'Catalyst', archetype: 4, desc: 'Intent in motion, charging forward. Action creating change through momentum.' },
    64: { name: 'Steward of Intent', trad: 'Queen of Wands', channel: 'Intent', role: 'Steward', archetype: 7, desc: 'Mature direction held with warmth. Tending the fire without burning out.' },
    65: { name: 'Executor of Intent', trad: 'King of Wands', channel: 'Intent', role: 'Executor', archetype: 12, desc: 'Mastery of directed will. Knowing when to release as well as push.' },
    66: { name: 'Initiate of Cognition', trad: 'Page of Swords', channel: 'Cognition', role: 'Initiate', archetype: 2, desc: 'Fresh curiosity, eager to understand. Mental energy before focus.' },
    67: { name: 'Catalyst of Cognition', trad: 'Knight of Swords', channel: 'Cognition', role: 'Catalyst', archetype: 15, desc: 'Thought in rapid motion. Cutting through to truth with speed.' },
    68: { name: 'Steward of Cognition', trad: 'Queen of Swords', channel: 'Cognition', role: 'Steward', archetype: 14, desc: 'Clear perception held with discernment. Truth-telling tempered with wisdom.' },
    69: { name: 'Executor of Cognition', trad: 'King of Swords', channel: 'Cognition', role: 'Executor', archetype: 9, desc: 'Mastery of mind. Authority from disciplined clarity.' },
    70: { name: 'Initiate of Resonance', trad: 'Page of Cups', channel: 'Resonance', role: 'Initiate', archetype: 18, desc: 'Fresh emotional sensitivity. The heart discovering its capacity.' },
    71: { name: 'Catalyst of Resonance', trad: 'Knight of Cups', channel: 'Resonance', role: 'Catalyst', archetype: 5, desc: 'Feeling in motion. Romantic pursuit of emotional truth.' },
    72: { name: 'Steward of Resonance', trad: 'Queen of Cups', channel: 'Resonance', role: 'Steward', archetype: 6, desc: 'Deep emotional attunement. Holding space with compassionate presence.' },
    73: { name: 'Executor of Resonance', trad: 'King of Cups', channel: 'Resonance', role: 'Executor', archetype: 11, desc: 'Mastery of emotion. Feeling deeply while maintaining equanimity.' },
    74: { name: 'Initiate of Structure', trad: 'Page of Pentacles', channel: 'Structure', role: 'Initiate', archetype: 3, desc: 'Fresh engagement with material world. Learning how things grow.' },
    75: { name: 'Catalyst of Structure', trad: 'Knight of Pentacles', channel: 'Structure', role: 'Catalyst', archetype: 16, desc: 'Steady progress through persistent effort. Slow but unstoppable.' },
    76: { name: 'Steward of Structure', trad: 'Queen of Pentacles', channel: 'Structure', role: 'Steward', archetype: 13, desc: 'Nurturing material abundance. Creating conditions for sustainable growth.' },
    77: { name: 'Executor of Structure', trad: 'King of Pentacles', channel: 'Structure', role: 'Executor', archetype: 8, desc: 'Mastery of material realm. Building that endures through generations.' }
};

// Archetype metadata (house, function) for associated archetype display
const ARCHETYPE_META = {
    0: { house: 'Gestalt', function: 'Seed' },
    1: { house: 'Gestalt', function: 'Medium' },
    2: { house: 'Spirit', function: 'Seed' },
    3: { house: 'Spirit', function: 'Medium' },
    4: { house: 'Mind', function: 'Seed' },
    5: { house: 'Mind', function: 'Medium' },
    6: { house: 'Emotion', function: 'Seed' },
    7: { house: 'Emotion', function: 'Medium' },
    8: { house: 'Body', function: 'Seed' },
    9: { house: 'Body', function: 'Medium' },
    10: { house: 'Portal', function: 'Ingress' },
    11: { house: 'Body', function: 'Fruition' },
    12: { house: 'Body', function: 'Feedback' },
    13: { house: 'Emotion', function: 'Fruition' },
    14: { house: 'Emotion', function: 'Feedback' },
    15: { house: 'Mind', function: 'Fruition' },
    16: { house: 'Mind', function: 'Feedback' },
    17: { house: 'Spirit', function: 'Fruition' },
    18: { house: 'Spirit', function: 'Feedback' },
    19: { house: 'Gestalt', function: 'Fruition' },
    20: { house: 'Gestalt', function: 'Feedback' },
    21: { house: 'Portal', function: 'Egress' }
};

// ============================================
// HOUSE DEFINITIONS
// ============================================
// Card offsets from house center (in local rotated coordinates)
// Cleaned up from user's manual positioning
const HOUSES = {
    gestalt: {
        archetypes: [0, 1, 19, 20],
        x: cx + 1,
        y: 540,
        color: 'multi',
        // Custom card offsets (archetypeOrder: 20, 19, 0, 1) - balanced spacing
        cardOffsets: [
            { x: -68, y: -40 },   // pos 0: id 20 (Awareness) - top left
            { x: 68, y: -40 },    // pos 1: id 19 (Actualization) - top right
            { x: -68, y: 97 },    // pos 2: id 0 (Potential) - bottom left
            { x: 68, y: 97 }      // pos 3: id 1 (Will) - bottom right
        ]
    },
    mind: {
        archetypes: [4, 5, 15, 16],
        x: cx - 450,
        y: 735,
        color: '#C9B545',  // Yellow/gold - upper left
        groupRotation: -45,  // Counter-clockwise
        // Custom card offsets (local coords): bottom-left, bottom-right, top-right, top-left
        cardOffsets: [
            { x: -68, y: 97 },   // pos 0: id 4 (Order) - bottom left
            { x: 68, y: 97 },    // pos 1: id 5 (Culture) - bottom right
            { x: 68, y: -40 },   // pos 2: id 15 (Abstraction) - top right
            { x: -68, y: -40 }   // pos 3: id 16 (Breakthrough) - top left
        ]
    },
    emotion: {
        archetypes: [6, 7, 13, 14],
        x: cx + 450,
        y: 735,
        color: '#C44444',  // Red - upper right
        groupRotation: 45,  // Clockwise
        // Custom card offsets (local coords)
        cardOffsets: [
            { x: -68, y: 97 },   // pos 0: id 6 (Compassion) - bottom left
            { x: 68, y: 97 },    // pos 1: id 7 (Drive) - bottom right
            { x: 68, y: -40 },   // pos 2: id 13 (Change) - top right
            { x: -68, y: -40 }   // pos 3: id 14 (Balance) - top left
        ]
    },
    body: {
        archetypes: [8, 9, 11, 12],
        x: cx - 450,
        y: 1205,
        color: '#3D6A99',  // Blue - lower left
        groupRotation: 45,  // Clockwise
        // Custom card offsets (local coords) - mirrored from emotion
        cardOffsets: [
            { x: 68, y: -40 },   // pos 0: id 8 (Fortitude) - top right
            { x: -68, y: -40 },  // pos 1: id 9 (Discipline) - top left
            { x: -68, y: 97 },   // pos 2: id 11 (Equity) - bottom left
            { x: 68, y: 97 }     // pos 3: id 12 (Sacrifice) - bottom right
        ]
    },
    spirit: {
        archetypes: [2, 3, 17, 18],
        x: cx + 450,
        y: 1205,
        color: '#D4707A',  // Pink/salmon - lower right
        groupRotation: -45,  // Counter-clockwise
        // Custom card offsets (local coords) - mirrored from mind
        cardOffsets: [
            { x: 68, y: -40 },   // pos 0: id 2 (Wisdom) - top right
            { x: -68, y: -40 },  // pos 1: id 3 (Nurturing) - top left
            { x: -68, y: 97 },   // pos 2: id 17 (Inspiration) - bottom left
            { x: 68, y: 97 }     // pos 3: id 18 (Imagination) - bottom right
        ]
    }
};

const PORTALS = {
    source: { archetype: 10, x: cx, y: 238 },
    creation: { archetype: 21, x: cx, y: 1320 }
};

// Suit to Channel mapping for elemental colors
const SUIT_CHANNELS = {
    wands: 'Intent',      // Fire
    swords: 'Cognition',  // Air
    cups: 'Resonance',    // Water
    pentacles: 'Structure' // Earth
};

const ALL_SUITS = ['wands', 'swords', 'cups', 'pentacles'];

// Agent roles by house (each house owns one role across all suits)
const HOUSE_ROLES = {
    spirit: { role: 'page', name: 'Initiate' },
    mind: { role: 'knight', name: 'Catalyst' },
    emotion: { role: 'queen', name: 'Steward' },
    body: { role: 'king', name: 'Executor' }
};

// Bound numbers by house (each house owns 2 numbers across all suits)
const HOUSE_BOUNDS = {
    gestalt: [1, 10],  // Aces and Tens
    spirit: [2, 9],
    mind: [3, 8],
    emotion: [4, 7],
    body: [5, 6]
};

// ============================================
// HOUSE OFFSETS - Manually positioned per house
// offset = CSS_position - house_center + cardSize/2
// boundSize: 45, agentSize: 50
// ============================================

// Which house to render bounds/agents for (null = all houses)
const POSITION_HOUSE = null;  // Set to 'mind', 'emotion', 'body', 'spirit', 'gestalt' to position one at a time

// Training/Sequence mode: cards appear one at a time
let SEQUENCE_MODE = false;  // Controlled by button - starts false so cards show normally

// Gestalt center: (901, 540) - DONE (Aces and 10s only, no agents)
const GESTALT_OFFSETS = {
    bounds: {
        'wands-inner': { x: -171, y: 99 },    // Ace of wands
        'wands-outer': { x: -171, y: 35 },    // 10 of wands
        'pentacles-inner': { x: 171, y: 101 },
        'pentacles-outer': { x: 170, y: 32 },
        'cups-inner': { x: -172, y: -36 },
        'cups-outer': { x: -172, y: -103 },
        'swords-inner': { x: 171, y: -43 },
        'swords-outer': { x: 171, y: -110 }
    }
};

// Mind center: (450, 680) - DONE
const MIND_OFFSETS = {
    bounds: {
        'wands-inner': { x: -49, y: 191 },
        'wands-outer': { x: -92, y: 149 },
        'pentacles-inner': { x: -145, y: 98 },
        'pentacles-outer': { x: -188, y: 54 },
        'cups-inner': { x: 192, y: -49 },
        'cups-outer': { x: 145, y: -95 },
        'swords-inner': { x: 98, y: -141 },
        'swords-outer': { x: 51, y: -187 }
    },
    agents: {
        wands: { x: 71, y: 174 },
        cups: { x: 168, y: 79 },
        pentacles: { x: -172, y: -73 },
        swords: { x: -75, y: -172 }
    }
};

// Emotion center: (1350, 680) - DONE
const EMOTION_OFFSETS = {
    bounds: {
        'wands-inner': { x: 55, y: 193 },
        'wands-outer': { x: 101, y: 145 },
        'pentacles-inner': { x: 149, y: 99 },
        'pentacles-outer': { x: 190, y: 55 },
        'cups-inner': { x: -188, y: -53 },
        'cups-outer': { x: -142, y: -98 },
        'swords-inner': { x: -92, y: -150 },
        'swords-outer': { x: -49, y: -193 }
    },
    agents: {
        wands: { x: -76, y: 174 },
        cups: { x: -174, y: 72 },
        pentacles: { x: 170, y: -75 },
        swords: { x: 78, y: -169 }
    }
};

// Body center: (450, 1220) - DONE
const BODY_OFFSETS = {
    bounds: {
        'wands-inner': { x: 92, y: 150 },
        'wands-outer': { x: 49, y: 197 },
        'pentacles-inner': { x: 190, y: 58 },
        'pentacles-outer': { x: 150, y: 99 },
        'cups-inner': { x: -145, y: -94 },
        'cups-outer': { x: -185, y: -53 },
        'swords-inner': { x: -53, y: -189 },
        'swords-outer': { x: -94, y: -147 }
    },
    agents: {
        wands: { x: -81, y: 169 },
        cups: { x: -176, y: 74 },
        pentacles: { x: 171, y: -79 },
        swords: { x: 79, y: -173 }
    }
};

// Spirit center: (1350, 1220) - DONE
const SPIRIT_OFFSETS = {
    bounds: {
        'wands-inner': { x: -90, y: 153 },
        'wands-outer': { x: -47, y: 193 },
        'pentacles-inner': { x: -189, y: 53 },
        'pentacles-outer': { x: -145, y: 92 },
        'cups-inner': { x: 152, y: -89 },
        'cups-outer': { x: 195, y: -48 },
        'swords-inner': { x: 53, y: -188 },
        'swords-outer': { x: 97, y: -144 }
    },
    agents: {
        wands: { x: 79, y: 170 },
        cups: { x: 173, y: 76 },
        pentacles: { x: -169, y: -77 },
        swords: { x: -78, y: -171 }
    }
};

// Get offsets for a house
function getHouseOffsets(houseName) {
    switch(houseName) {
        case 'mind': return MIND_OFFSETS;
        case 'emotion': return EMOTION_OFFSETS;
        case 'body': return BODY_OFFSETS;
        case 'spirit': return SPIRIT_OFFSETS;
        case 'gestalt': return GESTALT_OFFSETS;
        default: return MIND_OFFSETS;
    }
}

// ============================================
// HELPER FUNCTIONS
// ============================================
function createElement(tag, className, styles) {
    const el = document.createElement(tag);
    if (className) el.className = className;
    if (styles) Object.assign(el.style, styles);
    return el;
}

function getArchetypePath(id) {
    const name = ARCHETYPES[id].name.toLowerCase();
    return `/map/archetypes/${String(id).padStart(2, '0')}_${name}.png`;
}

function getBoundPath(suit, num) {
    return `/map/bounds/${suit}/${suit}_${String(num).padStart(2, '0')}.png`;
}

function getAgentPath(suit, rank) {
    return `/map/agents/${suit}_${rank}.png`;
}

// Convert full path to thumbnail path
// /map/archetypes/00_potential.png → /map/thumbs/archetypes/00_potential.png
function getThumbPath(fullPath) {
    return fullPath.replace('/map/', '/map/thumbs/');
}

// Get bound ID from suit and number
function getBoundId(suit, number) {
    const channel = SUIT_CHANNELS[suit];
    for (const [id, data] of Object.entries(BOUNDS)) {
        if (data.channel === channel && data.number === number) {
            return parseInt(id);
        }
    }
    return null;
}

// Get agent ID from suit and role
function getAgentId(suit, roleName) {
    const channel = SUIT_CHANNELS[suit];
    for (const [id, data] of Object.entries(AGENTS)) {
        if (data.channel === channel && data.role.toLowerCase() === roleName.toLowerCase()) {
            return parseInt(id);
        }
    }
    return null;
}

function createCard(type, src, title, subtitle, x, y, extraClass = '', channelOrId = null, labelText = null, cardId = null) {
    const card = createElement('div', `card ${type} ${extraClass}`.trim(), {
        left: x + 'px',
        top: y + 'px'
    });

    // Determine channel and description based on card type
    let channel = null;
    let description = '';
    let displayType = type.charAt(0).toUpperCase() + type.slice(1);
    let resolvedCardId = cardId;

    if (type === 'archetype' || type === 'portal') {
        // For archetypes/portals, channelOrId is the archetype ID
        resolvedCardId = channelOrId;
        const archData = ARCHETYPES[channelOrId];
        // Check for Gestalt archetype governing colors first, then fall back to archetype's own channel
        channel = GESTALT_ARCHETYPE_CHANNELS[channelOrId] || archData?.channel;
        description = archData?.desc || '';
        displayType = type === 'portal' ? 'Portal' : 'Archetype';
    } else if (type === 'bound') {
        channel = channelOrId;
        // Look up bound data by cardId if provided
        if (cardId && BOUNDS[cardId]) {
            description = BOUNDS[cardId].desc;
        } else {
            description = `A ${channel} bound card expressing focused energy through numeric form.`;
        }
        displayType = 'Bound';
    } else if (type === 'agent') {
        channel = channelOrId;
        // Look up agent data by cardId if provided
        if (cardId && AGENTS[cardId]) {
            description = AGENTS[cardId].desc;
        } else {
            description = `A ${channel} agent embodying active presence in the world.`;
        }
        displayType = 'Agent';
    }

    // Add elemental background
    let bgHtml = '';
    const bgColor = ELEMENT_COLORS[channel] || ELEMENT_COLORS[null];
    bgHtml = `<div class="element-bg" style="background: ${bgColor};"></div>`;

    // Add label if provided (default to title for archetypes/portals)
    const label = labelText !== null ? labelText : (type === 'archetype' || type === 'portal' ? title : '');
    const labelHtml = label ? `<div class="card-label">${label}</div>` : '';

    // Use thumbnail for display, keep full path for modal/fullscreen
    const thumbSrc = getThumbPath(src);
    card.innerHTML = `${bgHtml}<img src="${thumbSrc}" alt="${title}">${labelHtml}`;
    card.onclick = () => openInfoModal(src, title, subtitle, displayType, channel, description, resolvedCardId);

    // Add data attributes for sequence targeting
    card.dataset.cardType = type;
    if (resolvedCardId !== null) card.dataset.cardId = resolvedCardId;

    // In sequence mode, cards start hidden
    if (SEQUENCE_MODE) {
        card.classList.add('hidden');
    }

    return card;
}

// ============================================
// RENDER FUNCTIONS
// ============================================
function renderPortals(map) {
    // Source Portal (top)
    const source = PORTALS.source;
    const sourceCard = createCard(
        'portal',
        getArchetypePath(source.archetype),
        ARCHETYPES[source.archetype].name,
        ARCHETYPES[source.archetype].trad,
        source.x - CONFIG.portalSize/2,
        source.y,
        '',
        source.archetype  // Pass archetype ID for elemental color
    );
    map.appendChild(sourceCard);

    // Creation Portal (bottom)
    const creation = PORTALS.creation;
    const creationCard = createCard(
        'portal',
        getArchetypePath(creation.archetype),
        ARCHETYPES[creation.archetype].name,
        ARCHETYPES[creation.archetype].trad,
        creation.x - CONFIG.portalSize/2,
        creation.y,
        '',
        creation.archetype  // Pass archetype ID for elemental color
    );
    map.appendChild(creationCard);
}

function renderGestalt(map) {
    const g = HOUSES.gestalt;
    const size = CONFIG.houseSize;  // Same absolute size as other houses

    // Create the solid purple diamond background (Quintessence)
    const block = createElement('div', 'gestalt-block', {
        left: (g.x - size/2) + 'px',
        top: (g.y - size/2) + 'px',
        width: size + 'px',
        height: size + 'px'
    });
    map.appendChild(block);

    // Place 4 archetypes using custom offsets or default 2x2 grid
    const cardW = CONFIG.archetypeSize;
    const cardH = cardW * 1.5;
    const gap = 6;
    const containerSize = 400;  // Same as other houses for consistency

    // Create group container for draggable cards (no rotation for gestalt)
    const groupContainer = createElement('div', 'archetype-group archetype-group-gestalt', {
        position: 'absolute',
        left: (g.x - containerSize/2) + 'px',
        top: (g.y - containerSize/2) + 'px',
        width: containerSize + 'px',
        height: containerSize + 'px'
    });

    // Archetypes order: 20, 19, 0, 1 for the 2x2 grid
    const archetypeOrder = [20, 19, 0, 1];

    archetypeOrder.forEach((id, i) => {
        let cardX, cardY;

        if (g.cardOffsets && g.cardOffsets[i]) {
            // Use custom offset (from container center)
            const offset = g.cardOffsets[i];
            cardX = containerSize/2 + offset.x - cardW/2;
            cardY = containerSize/2 + offset.y - cardH/2;
        } else {
            // Default 2x2 grid positioning
            const gridW = cardW * 2 + gap;
            const gridH = cardH * 2 + gap;
            const col = i % 2;
            const row = Math.floor(i / 2);
            cardX = containerSize/2 - gridW/2 + col * (cardW + gap);
            cardY = containerSize/2 - gridH/2 + row * (cardH + gap);
        }

        const card = createCard(
            'archetype',
            getArchetypePath(id),
            ARCHETYPES[id].name,
            ARCHETYPES[id].trad,
            cardX,
            cardY,
            '',
            id  // Pass archetype ID for elemental color
        );
        // Gestalt doesn't rotate, no counter-rotation needed
        groupContainer.appendChild(card);
    });

    map.appendChild(groupContainer);

    // Render Gestalt bounds (Aces and 10s) if not filtered out
    if (POSITION_HOUSE === null || POSITION_HOUSE === 'gestalt') {
        const boundSize = CONFIG.boundSize;
        const houseBoundNums = HOUSE_BOUNDS.gestalt;  // [1, 10]

        ALL_SUITS.forEach((suit) => {
            const channel = SUIT_CHANNELS[suit];
            const innerNum = houseBoundNums[0];  // 1 (Ace)
            const outerNum = houseBoundNums[1];  // 10

            const innerOffset = GESTALT_OFFSETS.bounds[`${suit}-inner`];
            const outerOffset = GESTALT_OFFSETS.bounds[`${suit}-outer`];

            // Ace
            const aceId = getBoundId(suit, innerNum);
            const aceData = BOUNDS[aceId];
            const aceCard = createCard(
                'bound',
                getBoundPath(suit, innerNum),
                aceData?.name || `Ace of ${suit}`,
                aceData?.trad || '',
                g.x + innerOffset.x - boundSize/2,
                g.y + innerOffset.y - boundSize/2,
                '',
                channel,
                'Ace',  // Label
                aceId   // Card ID for full data
            );
            aceCard.dataset.house = 'gestalt';
            aceCard.dataset.suit = suit;
            aceCard.dataset.num = innerNum;
            aceCard.dataset.index = `bound-${suit}-${innerNum}`;
            map.appendChild(aceCard);

            // 10
            const tenId = getBoundId(suit, outerNum);
            const tenData = BOUNDS[tenId];
            const tenCard = createCard(
                'bound',
                getBoundPath(suit, outerNum),
                tenData?.name || `10 of ${suit}`,
                tenData?.trad || '',
                g.x + outerOffset.x - boundSize/2,
                g.y + outerOffset.y - boundSize/2,
                '',
                channel,
                '10',  // Label
                tenId  // Card ID for full data
            );
            tenCard.dataset.house = 'gestalt';
            tenCard.dataset.suit = suit;
            tenCard.dataset.num = outerNum;
            tenCard.dataset.index = `bound-${suit}-${outerNum}`;
            map.appendChild(tenCard);
        });
    }

    // House label - centered below the house
    const label = createElement('div', 'label house-name gestalt', {
        left: (g.x) + 'px',
        top: (g.y + size/2 + 20) + 'px',
        transform: 'translateX(-50%)'
    });
    label.textContent = 'Gestalt';
    map.appendChild(label);
}

function renderHouse(map, houseName) {
    const house = HOUSES[houseName];
    if (houseName === 'gestalt') return; // Skip gestalt (rendered separately)

    const size = CONFIG.houseSize;

    // Create diamond background
    const diamond = createElement('div', `house-block ${houseName}`, {
        left: (house.x - size/2) + 'px',
        top: (house.y - size/2) + 'px',
        width: size + 'px',
        height: size + 'px'
    });
    map.appendChild(diamond);

    // Place 4 archetypes in a rotated group container
    const cardW = CONFIG.archetypeSize;
    const cardH = cardW * 1.5;
    const gap = 6;

    // Container size - large enough to hold cards at custom offsets
    const containerSize = 400;  // Generous size for custom positioning

    // Create a container for the group (for rotation)
    const rotation = house.groupRotation || 0;
    const groupContainer = createElement('div', `archetype-group archetype-group-${houseName}`, {
        position: 'absolute',
        left: (house.x - containerSize/2) + 'px',
        top: (house.y - containerSize/2) + 'px',
        width: containerSize + 'px',
        height: containerSize + 'px',
        transform: `rotate(${rotation}deg)`,
        transformOrigin: 'center center'
    });

    // Position cards using custom offsets or default 2x2 grid
    house.archetypes.forEach((id, i) => {
        let cardX, cardY;

        if (house.cardOffsets && house.cardOffsets[i]) {
            // Use custom offset (from container center)
            const offset = house.cardOffsets[i];
            cardX = containerSize/2 + offset.x - cardW/2;
            cardY = containerSize/2 + offset.y - cardH/2;
        } else {
            // Default 2x2 grid positioning
            const gridW = cardW * 2 + gap;
            const gridH = cardH * 2 + gap;
            const col = i % 2;
            const row = Math.floor(i / 2);
            cardX = containerSize/2 - gridW/2 + col * (cardW + gap);
            cardY = containerSize/2 - gridH/2 + row * (cardH + gap);
        }

        const card = createCard(
            'archetype',
            getArchetypePath(id),
            ARCHETYPES[id].name,
            ARCHETYPES[id].trad,
            cardX,
            cardY,
            '',
            id  // Pass archetype ID for elemental color
        );
        groupContainer.appendChild(card);
    });

    map.appendChild(groupContainer);

    // Only render bounds/agents for specific house if POSITION_HOUSE is set
    if (POSITION_HOUSE !== null && houseName !== POSITION_HOUSE) {
        // House label only for non-active houses
        const label = createElement('div', 'label house-name', {
            left: (house.x - 25) + 'px',
            top: (house.y + size/2 + 20) + 'px'
        });
        label.textContent = houseName.charAt(0).toUpperCase() + houseName.slice(1);
        map.appendChild(label);
        return;
    }

    const houseBoundNums = HOUSE_BOUNDS[houseName];
    const houseRole = HOUSE_ROLES[houseName];
    const offsets = getHouseOffsets(houseName);

    const boundSize = CONFIG.boundSize;
    const agentSize = CONFIG.agentSize;

    // Place bounds using calculated offsets
    ALL_SUITS.forEach((suit) => {
        const channel = SUIT_CHANNELS[suit];
        const innerNum = houseBoundNums[0];  // Lower number (closer to center)
        const outerNum = houseBoundNums[1];  // Higher number (further from center)

        const innerOffset = offsets.bounds[`${suit}-inner`];
        const outerOffset = offsets.bounds[`${suit}-outer`];

        // Inner bound (lower number, closer to center)
        const innerId = getBoundId(suit, innerNum);
        const innerData = BOUNDS[innerId];
        const innerCard = createCard(
            'bound',
            getBoundPath(suit, innerNum),
            innerData?.name || `${innerNum} of ${suit}`,
            innerData?.trad || '',
            house.x + innerOffset.x - boundSize/2,
            house.y + innerOffset.y - boundSize/2,
            '',
            channel,
            String(innerNum),  // Label
            innerId  // Card ID for full data
        );
        innerCard.dataset.house = houseName;
        innerCard.dataset.suit = suit;
        innerCard.dataset.num = innerNum;
        innerCard.dataset.index = `bound-${suit}-${innerNum}`;
        innerCard.style.setProperty('--card-rotation', `${rotation}deg`);
        map.appendChild(innerCard);

        // Outer bound (higher number, further from center)
        const outerId = getBoundId(suit, outerNum);
        const outerData = BOUNDS[outerId];
        const outerCard = createCard(
            'bound',
            getBoundPath(suit, outerNum),
            outerData?.name || `${outerNum} of ${suit}`,
            outerData?.trad || '',
            house.x + outerOffset.x - boundSize/2,
            house.y + outerOffset.y - boundSize/2,
            '',
            channel,
            String(outerNum),  // Label
            outerId  // Card ID for full data
        );
        outerCard.dataset.house = houseName;
        outerCard.dataset.suit = suit;
        outerCard.dataset.num = outerNum;
        outerCard.dataset.index = `bound-${suit}-${outerNum}`;
        outerCard.style.setProperty('--card-rotation', `${rotation}deg`);
        map.appendChild(outerCard);
    });

    // Place agents at corners
    ALL_SUITS.forEach((suit) => {
        const channel = SUIT_CHANNELS[suit];
        const agentOffset = offsets.agents[suit];

        const agentId = getAgentId(suit, houseRole.name);
        const agentData = AGENTS[agentId];
        const agentCard = createCard(
            'agent',
            getAgentPath(suit, houseRole.role),
            agentData?.name || `${houseRole.name} of ${suit}`,
            agentData?.trad || '',
            house.x + agentOffset.x - agentSize/2,
            house.y + agentOffset.y - agentSize/2,
            '',
            channel,
            houseRole.name,  // Label
            agentId  // Card ID for full data
        );
        agentCard.dataset.house = houseName;
        agentCard.dataset.suit = suit;
        agentCard.dataset.role = houseRole.role;
        agentCard.dataset.index = `agent-${suit}`;
        agentCard.style.setProperty('--card-rotation', `${rotation}deg`);
        map.appendChild(agentCard);
    });

    // House label - positioned just beyond the inner-edge agents (toward map center)
    // Inner edge agents are furthest from house center toward map center
    // Body/Spirit: inner edge is UP (negative y), Mind/Emotion: inner edge is DOWN (positive y)
    const labelConfig = {
        mind: { x: 160, y: 165, rotation: -45 },     // inner edge: down-right toward map center
        emotion: { x: -160, y: 165, rotation: 45 },  // inner edge: down-left toward map center
        body: { x: 160, y: -165, rotation: 45 },     // inner edge: up-right toward map center
        spirit: { x: -160, y: -165, rotation: -45 }  // inner edge: up-left toward map center
    };
    const cfg = labelConfig[houseName];
    const label = createElement('div', `label house-name ${houseName}`, {
        left: (house.x + cfg.x) + 'px',
        top: (house.y + cfg.y) + 'px',
        transform: `translate(-50%, -50%) rotate(${cfg.rotation}deg)`,
        transformOrigin: 'center center'
    });
    label.textContent = houseName.charAt(0).toUpperCase() + houseName.slice(1);
    map.appendChild(label);
}

// ============================================
// MAIN RENDER
// ============================================
function render() {
    const map = document.getElementById('map');

    // Render in order (back to front)
    renderPortals(map);
    renderGestalt(map);

    // Render the 4 peripheral houses
    // Upper: mind (left), emotion (right)
    // Lower: body (left), spirit (right)
    ['mind', 'emotion', 'body', 'spirit'].forEach(name => {
        renderHouse(map, name);
    });
    // Title moved to fixed HTML header at top of page
}

// ============================================
// SEQUENCE MODE: Animated card reveal
// ============================================
function showNarration(text) {
    const narration = document.getElementById('narration');
    narration.textContent = text;
    narration.classList.add('visible');
}

function hideNarration() {
    const narration = document.getElementById('narration');
    narration.classList.remove('visible');
}

function startRevealSequence() {
    const ARCHETYPE_DELAY = 333;  // ms between each archetype
    const BOUND_REVEAL_DELAY = 800;  // ms after last archetype before bounds

    // First, hide ALL cards and reset narration
    const allCards = document.querySelectorAll('.card');
    allCards.forEach(card => {
        card.classList.add('hidden');
        card.classList.remove('revealed');
    });
    hideNarration();

    // Show opening narration
    setTimeout(() => {
        showNarration('The 22 Archetypes\n0 → 21');
    }, 200);

    // Archetype reveal order: 0-21
    const archetypeOrder = [];
    for (let i = 0; i <= 21; i++) {
        archetypeOrder.push(i);
    }

    // Find and reveal archetypes in order
    let delay = 1200;  // Initial delay to let narration show
    archetypeOrder.forEach((id) => {
        setTimeout(() => {
            const card = document.querySelector(`.card[data-card-id="${id}"]`);
            if (card) {
                card.classList.remove('hidden');
                card.classList.add('revealed');
            }
        }, delay);
        delay += ARCHETYPE_DELAY;
    });

    // After all archetypes, show bounds narration then reveal
    setTimeout(() => {
        showNarration('The 40 Bounds\nAces through Tens');
    }, delay);

    setTimeout(() => {
        const bounds = document.querySelectorAll('.card.bound.hidden');
        bounds.forEach(card => {
            card.classList.remove('hidden');
            card.classList.add('revealed');
        });
    }, delay + BOUND_REVEAL_DELAY);

    // After bounds, show agents narration then reveal
    setTimeout(() => {
        showNarration('The 16 Agents\nInitiate · Catalyst · Steward · Executor');
    }, delay + BOUND_REVEAL_DELAY + 800);

    setTimeout(() => {
        const agents = document.querySelectorAll('.card.agent.hidden');
        agents.forEach(card => {
            card.classList.remove('hidden');
            card.classList.add('revealed');
        });
    }, delay + BOUND_REVEAL_DELAY + 1600);

    // Hide narration at end
    setTimeout(() => {
        hideNarration();
    }, delay + BOUND_REVEAL_DELAY + 3000);
}

// ============================================
// MODAL FUNCTIONS (Two-stage: Info panel → Fullscreen)
// ============================================
let currentCardInfo = null;  // Track current card for fullscreen
let navigationHistory = [];  // Track navigation history for back button

// Get card ID from image path
function getCardIdFromPath(src) {
    // Archetype: /map/archetypes/00_potential.png
    const archMatch = src.match(/archetypes\/(\d+)_/);
    if (archMatch) return parseInt(archMatch[1]);

    // Bound: /map/bounds/wands/wands_01.png
    const boundMatch = src.match(/bounds\/(\w+)\/\w+_(\d+)/);
    if (boundMatch) {
        const suit = boundMatch[1];
        const num = parseInt(boundMatch[2]);
        // Find the bound ID
        for (const [id, data] of Object.entries(BOUNDS)) {
            if (data.number === num &&
                data.channel === SUIT_CHANNELS[suit]) {
                return parseInt(id);
            }
        }
    }

    // Agent: /map/agents/wands_page.png
    const agentMatch = src.match(/agents\/(\w+)_(\w+)/);
    if (agentMatch) {
        const suit = agentMatch[1];
        const role = agentMatch[2];
        // Find the agent ID
        for (const [id, data] of Object.entries(AGENTS)) {
            if (data.channel === SUIT_CHANNELS[suit] &&
                data.role.toLowerCase() === role) {
                return parseInt(id);
            }
        }
    }

    return null;
}

// Open modal for a specific card by ID
function openCardById(cardId) {
    if (cardId === null || cardId === undefined) return;

    let cardData, cardType, src;

    if (cardId >= 0 && cardId <= 21) {
        // Archetype
        cardData = ARCHETYPES[cardId];
        cardType = (cardId === 10 || cardId === 21) ? 'Portal' : 'Archetype';
        src = getArchetypePath(cardId);
    } else if (cardId >= 22 && cardId <= 61) {
        // Bound
        cardData = BOUNDS[cardId];
        cardType = 'Bound';
        const suit = Object.keys(SUIT_CHANNELS).find(s => SUIT_CHANNELS[s] === cardData.channel);
        src = getBoundPath(suit, cardData.number);
    } else if (cardId >= 62 && cardId <= 77) {
        // Agent
        cardData = AGENTS[cardId];
        cardType = 'Agent';
        const suit = Object.keys(SUIT_CHANNELS).find(s => SUIT_CHANNELS[s] === cardData.channel);
        const role = cardData.role.toLowerCase();
        src = getAgentPath(suit, role === 'initiate' ? 'page' : role === 'catalyst' ? 'knight' : role === 'steward' ? 'queen' : 'king');
    }

    if (cardData) {
        displayCardInModal(cardId, cardData, cardType, src);
    }
}

// Main modal display function
function displayCardInModal(cardId, cardData, cardType, src) {
    currentCardInfo = {
        src,
        title: cardData.name,
        subtitle: cardData.trad,
        cardId
    };

    document.getElementById('info-img').src = src;
    document.getElementById('info-title').textContent = cardData.name;
    document.getElementById('info-trad').textContent = cardData.trad || '';
    document.getElementById('info-desc').textContent = cardData.desc || '';

    // Set badge
    const badge = document.getElementById('info-badge');
    badge.textContent = cardType;
    badge.className = 'info-panel-badge ' + cardType.toLowerCase();

    // Set channel
    const channelEl = document.getElementById('info-channel');
    channelEl.textContent = cardData.channel ? `${cardData.channel} Channel` : '';

    // Handle archetype metadata section
    const archetypeMetaEl = document.getElementById('info-archetype-meta');
    const associatedEl = document.getElementById('info-associated');

    if (cardType === 'Archetype' || cardType === 'Portal') {
        // Show archetype metadata
        const meta = ARCHETYPE_META[cardId];
        if (meta) {
            document.getElementById('info-house').textContent = meta.house;
            document.getElementById('info-house').onclick = () => showHouseInfo(meta.house);
            document.getElementById('info-process').textContent = meta.function;

            // Show channel row if archetype has a channel
            const channelRow = document.getElementById('info-channel-row');
            if (cardData.channel) {
                channelRow.style.display = 'flex';
                document.getElementById('info-arch-channel').textContent = cardData.channel;
                document.getElementById('info-arch-channel').onclick = () => showChannelInfo(cardData.channel);
            } else {
                channelRow.style.display = 'none';
            }

            archetypeMetaEl.style.display = 'block';
        }
        associatedEl.style.display = 'none';
    } else {
        // Hide archetype metadata, show associated archetype for bounds/agents
        archetypeMetaEl.style.display = 'none';

        const archetypeId = cardData.archetype;
        if (archetypeId !== undefined && ARCHETYPES[archetypeId]) {
            const assocArch = ARCHETYPES[archetypeId];
            const assocMeta = ARCHETYPE_META[archetypeId];

            // Set header based on card type
            document.getElementById('associated-header').textContent =
                cardType === 'Agent' ? 'Embodies' : 'Expresses';

            // Set associated archetype info
            const assocName = document.getElementById('associated-name');
            assocName.textContent = assocArch.name;
            assocName.onclick = () => navigateToCard(archetypeId);

            document.getElementById('associated-desc').textContent = assocArch.desc || '';

            // Set associated metadata
            document.getElementById('associated-house').textContent = assocMeta?.house || '';
            document.getElementById('associated-process').textContent = assocMeta?.function || '';
            document.getElementById('associated-channel').textContent = assocArch.channel || 'Quintessence';

            associatedEl.style.display = 'block';
        } else {
            associatedEl.style.display = 'none';
        }
    }

    // Update back button visibility
    const navEl = document.getElementById('info-nav');
    navEl.style.display = navigationHistory.length > 0 ? 'block' : 'none';

    document.getElementById('info-modal').classList.add('active');
}

// Navigate to a card (with history)
function navigateToCard(cardId) {
    // Save current card to history before navigating
    if (currentCardInfo && currentCardInfo.cardId !== undefined) {
        navigationHistory.push(currentCardInfo.cardId);
    }
    openCardById(cardId);
}

// Navigate back in history
function navigateBack() {
    if (navigationHistory.length > 0) {
        const prevCardId = navigationHistory.pop();
        openCardById(prevCardId);
    }
}

// Show house info (placeholder - could expand later)
function showHouseInfo(house) {
    // For now, find first archetype in that house and show it
    for (const [id, meta] of Object.entries(ARCHETYPE_META)) {
        if (meta.house === house) {
            navigateToCard(parseInt(id));
            return;
        }
    }
}

// Show channel info (placeholder - could expand later)
function showChannelInfo(channel) {
    // Find first archetype with that channel
    for (const [id, data] of Object.entries(ARCHETYPES)) {
        if (data.channel === channel) {
            navigateToCard(parseInt(id));
            return;
        }
    }
}

// Legacy openInfoModal - now used by createCard
function openInfoModal(src, title, subtitle, cardType, channel, description, cardId) {
    // Don't open modal if we just finished dragging
    if (wasDragging) return;

    // Clear navigation history on fresh open
    navigationHistory = [];

    // If we have a cardId, use the new system
    if (cardId !== undefined) {
        openCardById(cardId);
        return;
    }

    // Fallback for legacy calls without cardId
    currentCardInfo = { src, title, subtitle };

    document.getElementById('info-img').src = src;
    document.getElementById('info-title').textContent = title;
    document.getElementById('info-trad').textContent = subtitle || '';
    document.getElementById('info-desc').textContent = description || '';

    const badge = document.getElementById('info-badge');
    badge.textContent = cardType;
    badge.className = 'info-panel-badge ' + cardType.toLowerCase();

    const channelEl = document.getElementById('info-channel');
    channelEl.textContent = channel ? `${channel} Channel` : '';

    document.getElementById('info-archetype-meta').style.display = 'none';
    document.getElementById('info-associated').style.display = 'none';
    document.getElementById('info-nav').style.display = 'none';

    document.getElementById('info-modal').classList.add('active');
}

function closeInfoModal() {
    document.getElementById('info-modal').classList.remove('active');
    navigationHistory = [];  // Clear history on close
}

function openFullscreen() {
    if (!currentCardInfo) return;
    document.getElementById('fullscreen-img').src = currentCardInfo.src;
    document.getElementById('fullscreen-title').textContent = currentCardInfo.title;
    document.getElementById('fullscreen-sub').textContent = currentCardInfo.subtitle || '';
    document.getElementById('fullscreen-modal').classList.add('active');
}

function closeFullscreen() {
    document.getElementById('fullscreen-modal').classList.remove('active');
}

document.addEventListener('keydown', e => {
    if (e.key === 'Escape') {
        if (document.getElementById('fullscreen-modal').classList.contains('active')) {
            closeFullscreen();
        } else {
            closeInfoModal();
        }
    }
});

// ============================================
// DEV MODE - Draggable positioning
// ============================================
let devMode = true;
let dragging = null;
let dragInfo = null;
let dragStart = { mouseX: 0, mouseY: 0, cardX: 0, cardY: 0 };
let wasDragging = false;  // Track if we just finished dragging
let movedCards = {};  // Accumulate all moved card positions

function createDevPanel() {
    // Skip dev panel if not positioning a specific house
    if (POSITION_HOUSE === null) {
        devMode = false;
        return;
    }

    const toggle = createElement('div', 'dev-toggle');
    toggle.textContent = 'Dev Mode: ON';
    toggle.onclick = () => {
        devMode = !devMode;
        document.body.classList.toggle('dev-mode', devMode);
        toggle.textContent = `Dev Mode: ${devMode ? 'ON' : 'OFF'}`;
        panel.style.display = devMode ? 'block' : 'none';
    };
    document.body.appendChild(toggle);

    const panel = createElement('div', 'dev-panel');
    panel.id = 'dev-panel';
    panel.innerHTML = `
        <h3>Positioning: ${POSITION_HOUSE.toUpperCase()}</h3>
        <div style="font-size:10px;margin-bottom:8px;color:#888;">
            Center: (${HOUSES[POSITION_HOUSE].x}, ${HOUSES[POSITION_HOUSE].y})
        </div>
        <div id="coord-display">Drag bounds/agents to position them</div>
        <button onclick="copyCoords()">Copy Offsets</button>
        <button onclick="clearCoords()">Clear</button>
    `;
    document.body.appendChild(panel);
    document.body.classList.add('dev-mode');
}

function updateCoordDisplay() {
    const display = document.getElementById('coord-display');
    const entries = Object.entries(movedCards);
    if (entries.length === 0) {
        display.innerHTML = 'Drag bounds/agents to position them';
    } else {
        display.innerHTML = entries.map(([key, pos]) =>
            `<div class="coord-line">${key}: x=${pos.x}, y=${pos.y}</div>`
        ).join('');
    }
}

function copyCoords() {
    const text = Object.entries(movedCards)
        .map(([key, pos]) => `${key}: x=${pos.x}, y=${pos.y}`)
        .join('\n');
    navigator.clipboard.writeText(text);
    alert('All coordinates copied!');
}

function clearCoords() {
    movedCards = {};
    updateCoordDisplay();
}

function setupDragging() {
    const map = document.getElementById('map');

    map.addEventListener('mousedown', (e) => {
        if (!devMode) return;

        const card = e.target.closest('.card.bound, .card.agent');
        if (!card) return;

        // Store initial mouse position and card's CSS left/top
        dragStart.mouseX = e.clientX;
        dragStart.mouseY = e.clientY;
        dragStart.cardX = parseFloat(card.style.left) || 0;
        dragStart.cardY = parseFloat(card.style.top) || 0;

        dragging = card;
        dragInfo = {
            type: card.classList.contains('bound') ? 'bound' : 'agent',
            house: card.dataset.house,
            index: card.dataset.index
        };
        e.preventDefault();
    });

    document.addEventListener('mousemove', (e) => {
        if (!dragging) return;

        // Calculate how far mouse has moved from start
        const deltaX = e.clientX - dragStart.mouseX;
        const deltaY = e.clientY - dragStart.mouseY;

        // Mark that we actually dragged (moved more than a few pixels)
        if (Math.abs(deltaX) > 3 || Math.abs(deltaY) > 3) {
            wasDragging = true;
        }

        // Apply delta to original card position
        const newX = dragStart.cardX + deltaX;
        const newY = dragStart.cardY + deltaY;

        dragging.style.left = newX + 'px';
        dragging.style.top = newY + 'px';

        // Update display
        const display = document.getElementById('coord-display');
        display.innerHTML = `${dragInfo.type} [${dragInfo.house}][${dragInfo.index}]: x=${Math.round(newX)}, y=${Math.round(newY)}`;
    });

    document.addEventListener('mouseup', () => {
        // Save final position as OFFSET if we actually dragged
        if (dragging && wasDragging && dragInfo) {
            const cssX = Math.round(parseFloat(dragging.style.left) || 0);
            const cssY = Math.round(parseFloat(dragging.style.top) || 0);
            const house = HOUSES[POSITION_HOUSE];
            const cardSize = dragInfo.type === 'bound' ? CONFIG.boundSize : CONFIG.agentSize;

            // Convert CSS position to offset: offset = CSS - houseCenter + cardSize/2
            const offsetX = Math.round(cssX - house.x + cardSize/2);
            const offsetY = Math.round(cssY - house.y + cardSize/2);

            movedCards[dragInfo.index] = { x: offsetX, y: offsetY };
            updateCoordDisplay();
        }

        dragging = null;
        dragInfo = null;
        // Reset wasDragging after a brief delay (after click event fires)
        setTimeout(() => { wasDragging = false; }, 10);
    });
}

// ============================================
// ZOOM & PAN FUNCTIONALITY
// ============================================
let currentZoom = 1;
let panX = 0;
let panY = 0;
const MIN_ZOOM = 0.2;
const MAX_ZOOM = 2;
const ZOOM_STEP = 0.15;

function updateTransform() {
    const wrapper = document.getElementById('map-wrapper');
    wrapper.style.transform = `translate(${panX}px, ${panY}px) scale(${currentZoom})`;
    document.getElementById('zoom-level').textContent = Math.round(currentZoom * 100) + '%';
}

function zoomIn() {
    currentZoom = Math.min(MAX_ZOOM, currentZoom + ZOOM_STEP);
    updateTransform();
}

function zoomOut() {
    currentZoom = Math.max(MIN_ZOOM, currentZoom - ZOOM_STEP);
    updateTransform();
}

function zoomFit() {
    const container = document.getElementById('canvas-container');
    const mapWidth = CONFIG.mapWidth;
    const mapHeight = CONFIG.mapHeight;

    // Calculate scale to fit both dimensions with some padding
    const padding = 40;
    const scaleX = (container.clientWidth - padding) / mapWidth;
    const scaleY = (container.clientHeight - padding) / mapHeight;

    currentZoom = Math.min(scaleX, scaleY, 1); // Don't zoom larger than 100%
    panX = 0;
    panY = 0;
    updateTransform();
}

function zoomTo(level) {
    currentZoom = Math.max(MIN_ZOOM, Math.min(MAX_ZOOM, level));
    updateTransform();
}

// Mouse wheel zoom
document.getElementById('canvas-container').addEventListener('wheel', (e) => {
    e.preventDefault();
    const delta = e.deltaY > 0 ? -ZOOM_STEP : ZOOM_STEP;
    currentZoom = Math.max(MIN_ZOOM, Math.min(MAX_ZOOM, currentZoom + delta));
    updateTransform();
}, { passive: false });

// ============================================
// PAN/DRAG FUNCTIONALITY
// ============================================
let isPanning = false;
let panStartX = 0;
let panStartY = 0;
let panStartPanX = 0;
let panStartPanY = 0;

const container = document.getElementById('canvas-container');

// Mouse drag
container.addEventListener('mousedown', (e) => {
    // Only pan if clicking on container background, not on cards
    if (e.target === container || e.target.classList.contains('map-wrapper') || e.target.classList.contains('map')) {
        isPanning = true;
        panStartX = e.clientX;
        panStartY = e.clientY;
        panStartPanX = panX;
        panStartPanY = panY;
        container.style.cursor = 'grabbing';
        e.preventDefault();
    }
});

document.addEventListener('mousemove', (e) => {
    if (!isPanning) return;
    const dx = e.clientX - panStartX;
    const dy = e.clientY - panStartY;
    panX = panStartPanX + dx;
    panY = panStartPanY + dy;
    updateTransform();
});

document.addEventListener('mouseup', () => {
    if (isPanning) {
        isPanning = false;
        container.style.cursor = 'default';
    }
});

// Touch drag (mobile)
container.addEventListener('touchstart', (e) => {
    if (e.touches.length === 1) {
        const touch = e.touches[0];
        if (e.target === container || e.target.classList.contains('map-wrapper') || e.target.classList.contains('map')) {
            isPanning = true;
            panStartX = touch.clientX;
            panStartY = touch.clientY;
            panStartPanX = panX;
            panStartPanY = panY;
        }
    }
}, { passive: true });

container.addEventListener('touchmove', (e) => {
    if (!isPanning || e.touches.length !== 1) return;
    const touch = e.touches[0];
    const dx = touch.clientX - panStartX;
    const dy = touch.clientY - panStartY;
    panX = panStartPanX + dx;
    panY = panStartPanY + dy;
    updateTransform();
}, { passive: true });

container.addEventListener('touchend', () => {
    isPanning = false;
});

// ============================================
// INITIALIZE
// ============================================
render();
createDevPanel();
setupDragging();

// Set initial zoom to 63%
setTimeout(() => {
    zoomTo(0.63);
}, 50);

// Re-fit on window resize
window.addEventListener('resize', () => {
    // Only auto-fit if we're below 100%
    if (currentZoom < 1) {
        zoomFit();
    }
});

// ============================================
// BACKGROUND CONTROLS PANEL
// ============================================
const bgControlsToggle = document.getElementById('bg-controls-toggle');
const bgControlsPanel = document.getElementById('bg-controls-panel');
const bgControlsClose = document.getElementById('bg-controls-close');
const videoBg = document.querySelector('.video-background');
const opacitySlider = document.getElementById('opacity-slider');
const opacityValue = document.getElementById('opacity-value');
const blurSlider = document.getElementById('blur-slider');
const blurValue = document.getElementById('blur-value');
const videoToggle = document.getElementById('video-toggle');

// Toggle panel visibility
bgControlsToggle.addEventListener('click', () => {
    bgControlsPanel.classList.toggle('visible');
});

bgControlsClose.addEventListener('click', () => {
    bgControlsPanel.classList.remove('visible');
});

// Opacity control
opacitySlider.addEventListener('input', () => {
    const val = opacitySlider.value;
    opacityValue.textContent = val + '%';
    videoBg.style.opacity = val / 100;
});

// Blur control
blurSlider.addEventListener('input', () => {
    const val = blurSlider.value;
    blurValue.textContent = val + 'px';
    videoBg.style.filter = `blur(${val}px)`;
});

// Video toggle
videoToggle.addEventListener('change', () => {
    videoBg.style.display = videoToggle.checked ? 'block' : 'none';
});

// Close panel when clicking outside
document.addEventListener('click', (e) => {
    if (!bgControlsPanel.contains(e.target) && !bgControlsToggle.contains(e.target)) {
        bgControlsPanel.classList.remove('visible');
    }
});
</script>
</body>
</html>
